{
    "package": "native/rust@1_54_0",
    "version": "1.54.0",
    "type": "native",
    "download": {
        "kind": "tar.gz",
        "sha256": "d3d3b84a100e71628afecf1125dbaa9bfc54ef9578c4fd81d75dca34c96f2565",
        "url": "https://github.com/thepowersgang/mrustc/archive/06b87d1af49d2db3bd850fdee8888055dd540dd1.tar.gz"
    },
    "dependencies": [
        "all:native/cmake",
        "all:native/make",
        "all:native/patch",
        "all:native/perl",
        "all:native/zlib"
    ],
    "patches": [
        "codegen_c.cpp.patch"
    ],
    "build": {
        "env": [
            "all:PARLEVEL=$NUM_CORES"
        ],
        "steps": [
            "all:patch -p1 < $PATCH_DIR/rust/codegen_c.cpp.patch",
            "all:if [ $(uname) = 'Darwin' ] && [ $(uname -m) = 'arm64' ]; then sed -i.bak 's/STD_ENV_ARCH=[a-zA-Z0-9_]*/STD_ENV_ARCH=aarch64/' script-overrides/stable-1.54.0-macos/build_std.txt; else echo not patching for macos; fi",
            "all:if [ $(uname) = 'Linux' ] && [ $(uname -m) = 'aarch64' ]; then sed -i.bak 's/STD_ENV_ARCH=[a-zA-Z0-9_]*/STD_ENV_ARCH=arm64/' script-overrides/stable-1.54.0-linux/build_std.txt; else echo not patching for linux; fi",
            "all:sed -i.bak 's/^make$/make $@/' build-1.54.0.sh",
            "all:if [ $(uname) = 'Darwin' ]; then sed -i.bak 's/^[[:space:]]*RUSTC_TARGET ?= x86_64-apple-darwin/RUSTC_TARGET ?= aarch64-apple-darwin/' run_rustc/Makefile; else true; fi",
            "all:echo >> build-1.54.0.sh",
            "all:echo make -C run_rustc >> build-1.54.0.sh",
            "all:env -i CXXFLAGS_EXTRA=$CFLAGS LINKFLAGS_EXTRA=$LDFLAGS PATH=$PATH PARLEVEL=$NUM_CORES ./build-1.54.0.sh -j$NUM_CORES",
            "none:# FIXME bad dylib paths embedded in the rustc binary, forcing install_name_tool dark magic",
            "all:mkdir -p $STAGING_DIR$PREFIX/native/bin",
            "all:mkdir -p $STAGING_DIR$PREFIX/native/lib",
            "all:cp -a run_rustc/output-1.54.0/prefix/bin/* $STAGING_DIR$PREFIX/native/bin",
            "all:if [ $(uname) = 'Linux' ]; then cp -a run_rustc/output-1.54.0/prefix/lib/rustlib/*/lib/*.so $STAGING_DIR$PREFIX/native/lib; else true; fi",
            "all:cp -a run_rustc/output-1.54.0/prefix/lib/* $STAGING_DIR$PREFIX/native/lib",
            "all:if [ $(uname) = 'Darwin' ]; then install_name_tool -change $PWD/run_rustc/output-1.54.0/build-rustc/aarch64-apple-darwin/release/deps/librustc_driver.dylib @loader_path/../lib/rustlib/aarch64-apple-darwin/lib/librustc_driver.dylib $STAGING_DIR$PREFIX/native/bin/rustc_binary; else true; fi",
            "all:if [ $(uname) = 'Darwin' ]; then install_name_tool -change $PWD/run_rustc/output-1.54.0/build-std2/aarch64-apple-darwin/release/deps/libstd.dylib @loader_path/../lib/rustlib/aarch64-apple-darwin/lib/libstd.dylib $STAGING_DIR$PREFIX/native/bin/rustc_binary; else true; fi",
            "all:if [ $(uname) = 'Darwin' ]; then install_name_tool -change $PWD/run_rustc/output-1.54.0/build-std2/aarch64-apple-darwin/release/deps/libstd.dylib @loader_path/libstd.dylib $STAGING_DIR$PREFIX/native/lib/rustlib/aarch64-apple-darwin/lib/librustc_driver.dylib; else true; fi"
        ]
    }
}